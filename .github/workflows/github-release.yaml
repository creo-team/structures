name: Release
run-name: Release [${{ github.ref_name }}]

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      dry-run:
        description: 'Preview only (no tags, releases, or commits)'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  actions: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: release
        uses: creo-team/action-release@v1
        with:
          version-source: package-json
          changelog: true
          if-exists: skip
          dry-run: ${{ github.event_name == 'workflow_dispatch' && inputs.dry-run }}

      # Trigger Publish workflow with the new tag. Uses GH_PAT when GITHUB_TOKEN
      # lacks workflow_dispatch permission (common in org repos).
      - if: steps.release.outputs.created == 'true'
        uses: actions/github-script@v7
        env:
          RELEASE_TAG: ${{ steps.release.outputs.tag }}
        with:
          github-token: ${{ secrets.GH_PAT || github.token }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'npm-publish.yaml',
              ref: 'main',
              inputs: { tag: process.env.RELEASE_TAG }
            })
